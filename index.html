<!DOCTYPE HTML">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>New Web Project</title>
	</head>
	<body>
		<h1>New Web Project Page</h1> 
		<video id="videoInput" width="320" height="240"></video>
		<canvas id="canvasOutput"></canvas>
		<canvas id="canvasOutputHsv"></canvas>
		<canvas id="canvasOutputMask"></canvas>
		<canvas id="canvasOutputBg"></canvas>
		
		</br>
		<h3> Low value</h2>
		<input type="range">R</input>
		</br>
		<input type="range">G</input>
		</br>
		<input type="range">B</input>
		</br>
		
		<button onclick="captureImage();">Capture image</button>
		<button id = "buttonStartPause" onclick="pause();">Pause</button>

		<script src="https://webrtc.github.io/adapter/adapter-5.0.4.js" type="text/javascript"></script>
		<script src="js/utils.js" type="text/javascript"></script>
		<script async src="js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
		<script type="text/javascript">
			
			
			function pause(){
				video = document.getElementById('videoInput');
				buttonStartPause = document.getElementById("buttonStartPause");
                if (buttonStartPause.innerHTML == "Start")
                {
                    buttonStartPause.innerHTML = "Pause";
					video.play();
                }
                else {
                    buttonStartPause.innerHTML = "Start";
					video.pause();
                }
				
				
			}
		
			let video, src, hsv, mask, imgBg, cap;
		
			function captureImage() {				
				video = document.getElementById('videoInput');
				src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
			 	hsv = new cv.Mat(video.height, video.width, cv.CV_8UC1);
				mask = new cv.Mat(video.height, video.width, cv.CV_8UC1);
				imgBg = new cv.Mat(video.height, video.width, cv.CV_8UC1);
				cap = new cv.VideoCapture(video);
				
				
				processImage();
			};
		
			const FPS = 30;
			function processImage(){
				let begin = Date.now();
				cap.read(src);
				
				cv.cvtColor(src, hsv, cv.COLOR_BGR2HSV);
				//define range of blue color in HSV
				let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [50, 50, 50, 50]);
				let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [150, 150, 150, 255]);		
				// Threshold the HSV image to get only blue colors
				cv.inRange(hsv, low, high, mask);
				// Bitwise-AND mask and original image
				cv.bitwise_and(src, src, imgBg, mask);
				
				cv.imshow('canvasOutput', src);
				cv.imshow('canvasOutputHsv', hsv);
				cv.imshow('canvasOutputMask', mask);
				cv.imshow('canvasOutputBg', imgBg);
				
				let delay = 1000/FPS - (Date.now() - begin);
				setTimeout(processImage, delay);
			}

			function onOpenCvReady() {
				startStreamVideo()
			}

			function startStreamVideo() {
				video = document.getElementById("videoInput");
				// video is the id of video tag
				navigator.mediaDevices.getUserMedia({
					video : true,
					audio : false
				}).then(function(stream) {
					video.srcObject = stream;
					video.play();
				}).catch(function(err) {
					console.log("An error occurred! " + err);
				});
			}
		</script>
	</body>
</html>
